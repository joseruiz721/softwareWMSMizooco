<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#1a365d">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Dispositivos | Gestion Servibarras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/device-register.css">
  
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">Registro de Dispositivos</h1>
            <a href="/dashboard" class="btn btn-back">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="card">
            <h2>Seleccione el tipo de dispositivo</h2>
            
            <div class="device-type-tabs">
                <div class="device-type-tab active" data-tab="ordenador">Ordenadores</div>
                <div class="device-type-tab" data-tab="access_point">Access Point</div>
                <div class="device-type-tab" data-tab="reader">Readers</div>
                <div class="device-type-tab" data-tab="etiquetadora">Etiquetadoras</div>
                <div class="device-type-tab" data-tab="tablet">Tablets</div>
                <div class="device-type-tab" data-tab="lector_qr">Lectores QR</div>
            </div>

            <!-- Formulario din√°mico -->
            <form id="device-form" class="device-form active">
                <!-- Los campos se generar√°n din√°micamente con JavaScript -->
            </form>

            <div class="form-actions">
                <button type="button" class="btn btn-back" id="cancelBtn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save"></i> Guardar Dispositivo
                </button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        const tabs = document.querySelectorAll('.device-type-tab');
        const form = document.getElementById('device-form');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const statusMessage = document.getElementById('statusMessage');
        let currentTab = 'ordenador';

        // Definici√≥n de campos para cada tipo de dispositivo
        const deviceFields = {
            'ordenador': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'ip', label: 'Direcci√≥n IP', type: 'text', required: false },
                { 
                    id: 'serial', 
                    label: 'N√∫mero de Serie', 
                    type: 'text', 
                    required: false,
                    help: 'Si no tiene serial, escribir: "ninguno", "no aplica" o dejar vac√≠o'
                },
                { id: 'marca', label: 'Marca', type: 'text', required: false },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'observaciones', label: 'Observaciones', type: 'textarea', required: false }
            ],
            'access_point': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'ip', label: 'Direcci√≥n IP', type: 'text', required: false },
                { 
                    id: 'serial', 
                    label: 'N√∫mero de Serie', 
                    type: 'text', 
                    required: false,
                    help: 'Si no tiene serial, escribir: "ninguno", "no aplica" o dejar vac√≠o'
                },
                { id: 'modelo', label: 'Modelo', type: 'text', required: false },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'version', label: 'Versi√≥n', type: 'text', required: false },
                { id: 'mac', label: 'Direcci√≥n MAC', type: 'text', required: false },
                { id: 'arquitectura', label: 'Arquitectura', type: 'text', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'observacion', label: 'Observaciones', type: 'textarea', required: false }
            ],
            'reader': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'ip', label: 'Direcci√≥n IP', type: 'text', required: false },
                { id: 'no_maquina', label: 'No M√°quina', type: 'text', required: false },
                { 
                    id: 'serial', 
                    label: 'N√∫mero de Serie', 
                    type: 'text', 
                    required: false,
                    help: 'Si no tiene serial, escribir: "ninguno", "no aplica" o dejar vac√≠o'
                },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'mac', label: 'Direcci√≥n MAC', type: 'text', required: false },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'observaciones', label: 'Observaciones', type: 'textarea', required: false }
            ],
            'etiquetadora': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'ip', label: 'Direcci√≥n IP', type: 'text', required: false },
                { 
                    id: 'serial', 
                    label: 'N√∫mero de Serie', 
                    type: 'text', 
                    required: false,
                    help: 'Si no tiene serial, escribir: "ninguno", "no aplica" o dejar vac√≠o'
                },
                { id: 'modelo', label: 'Modelo', type: 'text', required: false },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'serial_aplicador', label: 'Serial Aplicador', type: 'text', required: false },
                { id: 'mac', label: 'Direcci√≥n MAC', type: 'text', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'observaciones', label: 'Observaciones', type: 'textarea', required: false }
            ],
            'tablet': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'ip', label: 'Direcci√≥n IP', type: 'text', required: false },
                { id: 'no_maquina', label: 'No M√°quina', type: 'text', required: false },
                { 
                    id: 'serial', 
                    label: 'N√∫mero de Serie', 
                    type: 'text', 
                    required: false,
                    help: 'Si no tiene serial, escribir: "ninguno", "no aplica" o dejar vac√≠o'
                },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'observaciones', label: 'Observaciones', type: 'textarea', required: false }
            ],
            'lector_qr': [
                { id: 'ubicacion', label: 'Ubicaci√≥n', type: 'text', required: true },
                { id: 'modelo', label: 'Modelo', type: 'text', required: true },
                { id: 'activo_fijo', label: 'Activo Fijo', type: 'text', placeholder: 'N√∫mero de activo fijo', required: false },
                { id: 'activo', label: 'Activo', type: 'select', options: ['S√≠', 'No'], values: ['true', 'false'], default: 'true', required: false },
                { id: 'estado', label: 'Estado', type: 'select', options: ['Activo', 'En reparaci√≥n', 'Da√±ado', 'Retirado'], default: 'Activo', required: false },
                { id: 'fecha', label: 'Fecha de Ingreso', type: 'date', required: true },
                { id: 'observaciones', label: 'Observaciones', type: 'textarea', required: false }
            ]
        };

        // Mapeo de nombres de tabla
        const tableNames = {
            'ordenador': 'ordenadores',
            'access_point': 'access_point',
            'reader': 'readers',
            'etiquetadora': 'etiquetadoras',
            'tablet': 'tablets',
            'lector_qr': 'lectores_qr'
        };

        // Cambiar entre pesta√±as
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.getAttribute('data-tab');
                renderForm(currentTab);
            });
        });

        // Renderizar formulario seg√∫n el tipo de dispositivo
        function renderForm(deviceType) {
            form.innerHTML = '';
            const fields = deviceFields[deviceType];
            
            // Dividir campos en dos columnas
            const midPoint = Math.ceil(fields.length / 2);
            const firstCol = fields.slice(0, midPoint);
            const secondCol = fields.slice(midPoint);
            
            const formRow = document.createElement('div');
            formRow.className = 'form-row';
            
            // Primera columna
            const firstColDiv = document.createElement('div');
            firstColDiv.className = 'form-col';
            firstCol.forEach(field => {
                const fieldElement = createField(field, deviceType);
                if (fieldElement) firstColDiv.appendChild(fieldElement);
            });
            formRow.appendChild(firstColDiv);
            
            // Segunda columna
            const secondColDiv = document.createElement('div');
            secondColDiv.className = 'form-col';
            secondCol.forEach(field => {
                const fieldElement = createField(field, deviceType);
                if (fieldElement) secondColDiv.appendChild(fieldElement);
            });
            formRow.appendChild(secondColDiv);
            
            form.appendChild(formRow);
            
            // Establecer fecha actual por defecto
            setDefaultDate(deviceType);
        }

        // Crear campo de formulario
        function createField(field, deviceType) {
            if (!field || !field.id) {
                console.error('Campo inv√°lido:', field);
                return null;
            }
            
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'form-group';
            
            const label = document.createElement('label');
            label.textContent = field.label;
            if (field.required) {
                label.className = 'required';
            }
            label.htmlFor = `${deviceType}-${field.id}`;
            fieldGroup.appendChild(label);
            
            let input;
            try {
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.id = `${deviceType}-${field.id}`;
                    input.name = field.id;
                    
                    // Agregar opci√≥n vac√≠a para campos no requeridos
                    if (!field.required) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = '-- Seleccionar --';
                        input.appendChild(emptyOption);
                    }
                    
                    const options = field.options || [];
                    const values = field.values || options;
                    
                    options.forEach((option, index) => {
                        const optionElement = document.createElement('option');
                        const value = values[index] !== undefined ? values[index] : option;
                        optionElement.value = value;
                        optionElement.textContent = option;
                        
                        // Establecer valor por defecto si existe
                        if (field.default && field.default === option) {
                            optionElement.selected = true;
                        }
                        
                        input.appendChild(optionElement);
                    });
                    
                } else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.id = `${deviceType}-${field.id}`;
                    input.name = field.id;
                    input.rows = 3;
                    
                    if (field.placeholder) {
                        input.placeholder = field.placeholder;
                    }
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.id = `${deviceType}-${field.id}`;
                    input.name = field.id;
                    
                    if (field.placeholder) {
                        input.placeholder = field.placeholder;
                    }
                    
                    // Establecer valor por defecto
                    if (field.default && field.type !== 'date') {
                        input.value = field.default;
                    }
                }
                
                // Asegurar que el campo tenga un valor por defecto vac√≠o si no lo tiene
                if (!input.value && input.type !== 'select') {
                    input.value = '';
                }
                
                fieldGroup.appendChild(input);
                
                // Agregar texto de ayuda para el campo serial
                if (field.id === 'serial' && field.help) {
                    const helpText = document.createElement('div');
                    helpText.className = 'serial-help';
                    helpText.innerHTML = `<i class="fas fa-info-circle"></i> ${field.help}`;
                    fieldGroup.appendChild(helpText);
                }
                
                return fieldGroup;
                
            } catch (error) {
                console.error('Error creando campo:', field, error);
                return null;
            }
        }

        // Funci√≥n para validar el formulario
        function validateForm(tab) {
            const fields = deviceFields[tab];
            let isValid = true;
            
            // Limpiar errores previos
            clearErrors();
            
            // Validar cada campo requerido
            fields.forEach(field => {
                if (field.required) {
                    const input = document.getElementById(`${tab}-${field.id}`);
                    
                    if (!input) {
                        console.error(`Campo no encontrado: ${tab}-${field.id}`);
                        isValid = false;
                        return;
                    }
                    
                    let value = input.value;
                    
                    // Asegurar que el valor no sea undefined o null
                    if (value === undefined || value === null) {
                        value = '';
                    }
                    
                    // Convertir a string y recortar espacios
                    value = value.toString().trim();
                    
                    if (!value) {
                        input.classList.add('error-border');
                        isValid = false;
                    }
                }
            });
            
            if (!isValid) {
                showStatus('error', 'Por favor complete todos los campos obligatorios (*)');
            }
            
            return isValid;
        }

        // Limpiar errores de validaci√≥n
        function clearErrors() {
            const errorFields = form.querySelectorAll('.error-border');
            errorFields.forEach(field => {
                field.classList.remove('error-border');
            });
        }

        // Funci√≥n para obtener datos del formulario
        function getFormData(tab) {
            const formData = {};
            const fields = deviceFields[tab];
            
            fields.forEach(field => {
                const input = document.getElementById(`${tab}-${field.id}`);
                
                if (input) {
                    const value = input.value;
                    // Solo agregar si tiene valor o es el campo serial (que puede estar vac√≠o)
                    if (value !== undefined && value !== null) {
                        formData[field.id] = value;
                    }
                }
            });

            return formData;
        }

        // Guardar dispositivo - VERSI√ìN SIMPLIFICADA Y FUNCIONAL
        saveBtn.addEventListener('click', async function() {
            try {
                // Deshabilitar bot√≥n para evitar doble clic
                saveBtn.disabled = true;
                saveBtn.classList.add('loading');
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                
                // Validar formulario
                if (!validateForm(currentTab)) {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('loading');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Dispositivo';
                    return;
                }

                // Obtener datos del formulario
                const formData = getFormData(currentTab);
                
                console.log('üìù Datos capturados del formulario:', formData);
                
                // Procesar el campo serial - SIMPLIFICADO
                if (formData.serial !== undefined && formData.serial !== null) {
                    const serialValue = formData.serial.toString().trim();
                    if (serialValue === '') {
                        // Si est√° vac√≠o, enviarlo como string vac√≠o (el backend lo manejar√°)
                        formData.serial = '';
                    }
                }
                
                // Renombrar campo fecha a fecha_ingreso
                if (formData.fecha) {
                    formData.fecha_ingreso = formData.fecha;
                    delete formData.fecha;
                }
                
                // Convertir campo activo a booleano si existe
                if (formData.activo !== undefined) {
                    formData.activo = formData.activo === 'true' || formData.activo === true;
                }
                
                console.log('üì§ Datos procesados para enviar:', formData);
                
                // Mostrar mensaje de procesando
                showStatus('info', '‚åõ Registrando dispositivo...');
                
                // Enviar datos al servidor
                const response = await fetch(`/api/dispositivos/${tableNames[currentTab]}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('üì• Respuesta HTTP:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });
                
                // Parsear respuesta
                const result = await response.json();
                console.log('üìÑ Respuesta JSON:', result);
                
                // Restaurar bot√≥n
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Dispositivo';
                
                // Manejar respuesta
                if (response.ok && result.success) {
                    // √âXITO
                    const deviceName = deviceFields[currentTab][0]?.label || 'Dispositivo';
                    const successMessage = result.message || `${deviceName} registrado con √©xito`;
                    const idMessage = result.dispositivoId ? ` (ID: ${result.dispositivoId})` : '';
                    
                    showStatus('success', `‚úÖ ${successMessage}${idMessage}`);
                    
                    // Resetear formulario despu√©s de 3 segundos
                    setTimeout(() => {
                        resetForm(currentTab);
                    }, 3000);
                    
                } else {
                    // ERROR
                    const errorMessage = result.message || 'Error al registrar el dispositivo';
                    showStatus('error', `‚ùå ${errorMessage}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                
                // Restaurar bot√≥n
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Dispositivo';
                
                // Mostrar error apropiado
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showStatus('error', '‚ùå Error de conexi√≥n con el servidor');
                } else if (error.name === 'SyntaxError') {
                    showStatus('error', '‚ùå Error en la respuesta del servidor');
                } else {
                    showStatus('error', `‚ùå Error: ${error.message}`);
                }
            }
        });

        // Cancelar registro
        cancelBtn.addEventListener('click', function() {
            if (confirm('¬øEst√° seguro que desea cancelar el registro? Los datos no guardados se perder√°n.')) {
                resetForm(currentTab);
            }
        });

        // Funci√≥n para resetear el formulario
        function resetForm(tab) {
            // Limpiar todos los campos
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'date') {
                    // Para fecha, establecer hoy
                    const today = new Date().toISOString().split('T')[0];
                    input.value = today;
                } else if (input.type === 'select-one') {
                    // Para selects, restaurar valor por defecto si existe
                    const field = deviceFields[tab].find(f => f.id === input.name);
                    if (field && field.default) {
                        // Buscar la opci√≥n con el valor por defecto
                        for (let i = 0; i < input.options.length; i++) {
                            if (input.options[i].textContent === field.default || 
                                input.options[i].value === field.default) {
                                input.selectedIndex = i;
                                break;
                            }
                        }
                    } else {
                        // Si no hay valor por defecto, seleccionar primera opci√≥n
                        input.selectedIndex = 0;
                    }
                } else if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    // Para campos de texto, limpiar
                    input.value = '';
                }
                input.classList.remove('error-border');
            });
            
            // Limpiar mensajes de error
            clearErrors();
            
            // Mostrar mensaje informativo
            showStatus('info', 'üìù Formulario listo para nuevo registro');
        }

        // Funci√≥n para mostrar mensajes de estado
        function showStatus(type, message) {
            // Configurar nuevo mensaje
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            // Para mensajes de √©xito, mantener m√°s tiempo
            const timeout = type === 'success' ? 8000 : 5000;
            
            // Ocultar despu√©s del tiempo definido
            setTimeout(() => {
                if (statusMessage.textContent === message) {
                    statusMessage.style.display = 'none';
                }
            }, timeout);
        }

        // Establecer fecha actual por defecto
        function setDefaultDate(tab) {
            const dateInput = document.getElementById(`${tab}-fecha`);
            if (dateInput && dateInput.type === 'date') {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        }

        // Inicializar formulario
        renderForm(currentTab);
    });
</script>
</body>
</html>